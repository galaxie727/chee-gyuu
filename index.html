<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>チーと言えばギュウと答える</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
}
.app{
  max-width:560px;
  margin:0 auto;
  min-height:100svh;
  display:flex;
  flex-direction:column;
}

/* header */
header{
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  font-size:12px;
  font-weight:700;
}

/* screens */
.screen{flex:1;position:relative;overflow:hidden}
.bg{
  position:absolute; inset:0;
  background-size:cover;
  background-position:center;
  transform:scale(1.02);
  transition:transform .35s ease, filter .35s ease;
}
#startScreen .bg{background-image:url("girl_top.png")}
.overlay{
  position:absolute; inset:0;
  padding:16px;
  display:flex;
}

/* start */
#startScreen .overlay{
  justify-content:center;
  align-items:flex-end;
  padding-bottom:28px;
}
.startPanel{text-align:center}
.startTitle{
  font-size:18px;
  font-weight:900;
  letter-spacing:.14em;
  margin-bottom:14px;
  text-shadow:0 8px 22px rgba(0,0,0,.75);
}
.startBtns{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}

/* TOP: BEST 表示 */
.bestLine{
  font-size:12px;
  font-weight:900;
  letter-spacing:.12em;
  margin-bottom:12px;
  text-shadow:0 8px 22px rgba(0,0,0,.75);
  opacity:.95;
}
.bestNum{
  font-size:14px;
  letter-spacing:.08em;
}

/* TOP: NEW RECORD バッジ */
.badge{
  display:inline-block;
  margin-top:10px;
  padding:8px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  font-weight:900;
  letter-spacing:.12em;
  opacity:0;
  transform:translateY(6px) scale(.98);
  transition:opacity .22s, transform .22s;
}
.badge.show{
  opacity:1;
  transform:translateY(0) scale(1);
}
.badge .star{ color:#ffd54a; }

.startBtn{
  font-size:18px;
  padding:14px 18px;
  border:none;
  border-radius:14px;
  background:#ffffff22;
  color:#fff;
  font-weight:900;
  min-width:140px;
}

/* game */
#gameScreen .overlay{
  flex-direction:column;
  justify-content:space-between;
}
#gameScreen.chee .bg{transform:scale(1.12)}
#gameScreen.hold .bg{filter:brightness(.92)}

.vignette{
  position:absolute;inset:0;
  pointer-events:none;
  opacity:0;
  background:radial-gradient(circle,
    rgba(0,0,0,0) 45%,
    rgba(0,0,0,.45) 100%);
  transition:opacity .25s;
}
#gameScreen.chee .vignette{opacity:1}

/* cut */
.cut{
  position:absolute;inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity .28s;
}
#gameScreen.cut .cut{opacity:1}

/* announce */
.announce{
  position:absolute;inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:900;
  letter-spacing:.2em;
  opacity:0;
  pointer-events:none;
  transition:opacity .16s;
  text-shadow:0 10px 28px rgba(0,0,0,.85);
}
#gameScreen.announce .announce{opacity:1}

/* flash */
.flash{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.22);
  opacity:0;
  pointer-events:none;
  transition:opacity .08s ease-out;
}
.flash.on{ opacity:1; }

/* bubble */
.bubble{
  background:rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  min-height:120px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.question{
  font-size:20px;
  font-weight:700;
  line-height:1.45;
  opacity:1;
  transition:opacity .22s;
}
.question.hide{opacity:0}

.speech{
  align-self:flex-end;
  font-size:34px;
  font-weight:900;
  letter-spacing:.12em;
  min-height:40px;
  opacity:1;
  transform:scale(1);
}

/* チー娘の「チー！」（⭐︎⭐︎⭐︎だけ少し大きい） */
.cheeWord.big{ transform:scale(1.05); transform-origin:right bottom; }

/* ❤ */
.heartOnly{
  color:#ff2d55;
  text-shadow:0 8px 22px rgba(255,45,85,.35);
}
.heartGold{
  color:#ffd54a;
  text-shadow:0 10px 26px rgba(255,213,74,.45);
}

@keyframes heartPop{
  0%{ transform:scale(0.8); opacity:0; }
  55%{ transform:scale(1.25); opacity:1; }
  100%{ transform:scale(1); opacity:1; }
}
.heartPop{ animation:heartPop .22s ease-out; }

/* NEW RECORD：テキスト演出 */
@keyframes newRecordPop{
  0%{ transform:translateY(6px) scale(.98); opacity:0; }
  60%{ transform:translateY(0) scale(1.03); opacity:1; }
  100%{ transform:translateY(0) scale(1); opacity:1; }
}
.newRecord{
  display:inline-block;
  margin-right:10px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  letter-spacing:.12em;
  font-size:14px;
  font-weight:900;
  animation:newRecordPop .24s ease-out;
}

/* ⭐︎⭐︎⭐︎ 背景揺れ（軽め） */
@keyframes bgShake {
  0%   { transform: translate(0, 0) scale(1.12); }
  20%  { transform: translate(-2px, 1px) scale(1.12); }
  40%  { transform: translate(2px, -1px) scale(1.12); }
  60%  { transform: translate(-1px, -2px) scale(1.12); }
  80%  { transform: translate(1px, 2px) scale(1.12); }
  100% { transform: translate(0, 0) scale(1.12); }
}
#gameScreen.chee.stage3plus .bg{ animation:bgShake .35s infinite; }

/* choices */
.choices{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.choice{
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:900;
  color:#fff;
}
.choice:disabled{opacity:.55}

/* チー娘モード：10ボタン */
.choices.chee10 .choice{
  padding:12px;
  font-size:14px;
  border-radius:12px;
}

/* gauge (チー娘中だけ表示) */
.gauge{
  height:8px;
  background:#222;
  border-radius:999px;
  overflow:hidden;
  opacity:0;
  transform:translateY(8px);
  transition:opacity .16s, transform .16s;
  margin-bottom:10px;
}
.gauge.show{
  opacity:1;
  transform:translateY(0);
}
.gauge>div{
  height:100%;
  width:100%;
  transform-origin:left;
  transform:scaleX(0);
}

/* 難易度ごとのゲージ色 */
#gaugeBar.yellow{ background:linear-gradient(90deg,#ffe259,#ffa751); }
#gaugeBar.red{ background:linear-gradient(90deg,#ff416c,#ff4b2b); }

.hide{display:none}
</style>
</head>

<body>
<div class="app">

<header>
  <div>チーと言えばギュウと答える</div>
  <div id="counter">-</div>
</header>

<!-- START -->
<div id="startScreen" class="screen">
  <div class="bg"></div>
  <div class="overlay">
    <div class="startPanel">
      <div class="startTitle">ガチ！チー牛診断！！</div>

      <div class="bestLine">
        チー娘 BEST <span class="bestNum" id="bestOnTop">ステージ0</span>
      </div>

      <div class="startBtns">
        <button class="startBtn" id="startBtnNormal">START</button>
        <button class="startBtn" id="startBtnChee">チー娘モード</button>
      </div>

      <div class="badge" id="newRecordBadge">NEW RECORD <span class="star">★</span></div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen hide">
  <div class="bg"></div>
  <div class="vignette"></div>
  <div class="cut"></div>
  <div class="flash" id="flash"></div>
  <div class="announce">チー娘登場！！</div>

  <div class="overlay">
    <div class="bubble">
      <div id="question" class="question"></div>
      <div id="speech" class="speech"></div>
    </div>

    <div class="gauge" id="gaugeWrap"><div id="gaugeBar"></div></div>
    <div class="choices" id="choices"></div>
  </div>
</div>

</div>

<script>
/* ===== 画像 ===== */
const END_CLEAR_IMAGE = "girl_end.png";
const END_GOVER_IMAGE = "girl_gover.png";

/* ===== 記録保存（BESTステージ） ===== */
const CHEE_RECORD_KEY = "cheeGirlBestStage";
function getBestStage(){
  return Number(localStorage.getItem(CHEE_RECORD_KEY)) || 0;
}
function setBestStage(stage){
  localStorage.setItem(CHEE_RECORD_KEY, String(stage));
}

/* ===== 問題（45問） ===== */
const questions = [
  { text:"あなたはチー牛ですか？" },
  { text:"チーと言えば？" },
  { text:"石原さとみさんに「チー」と言われたら？" },
  { text:"ギュウと言ってもらいたい？" },
  { text:"チーズ牛丼を頼んだ人を一瞬だけ見てしまったことはありますか？" },
  { text:"知らない人を見て『チー牛かも』と思ってしまったことはありますか？" },
  { text:"あなたの友人にチー牛はいますか？" },
  { text:"大谷翔平選手に言ってほしい言葉第1位は『チー牛食おうぜ！』だと思いますか？" },
  { text:"麻雀には、チーをされた瞬間にギュウと答えるとチーを取り消す『チーギュウ返し』がある。本当だと思いますか？" },
  { text:"あなたは三度の飯よりチー牛が好きって本当ですか？" },
  { text:"あなたはチーズ牛丼の湯気でイケメンに見える時がありますか？" },
  { text:"あなたの好きな食べ物は1位チーズ牛丼特盛り、2位大盛り、3位並盛りですか？" },
  { text:"初めて麻雀をした時、チー/ポン/カンをチー/ギュウ/ドンと間違えたことがありますか？" },
  { text:"ハイチーズをハイチー牛だと思っていた時期がありますか？" },
  { text:"写真を撮る時、チーズ牛丼を持って写りそうになったことがありますか？" },
  { text:"チー牛は人口の2%しかいないと言われている。信じますか？" },
  { text:"チーと言われると、少しだけ反応してしまいますか？" },
  { text:"『ギュウ』と答える練習をしたことがありますか？" },
  { text:"チーズ牛丼を頼む人を見ると、なぜか目が行きますか？" },
  { text:"『チー牛かも』と思っても、口には出しませんか？" },
  { text:"牛カレーには牛肉、豚カレーには豚肉、鳥カレーには鶏肉、仮面ライダーカレーには仮面ライダーの肉が使われていると思いますか？" },
  { text:"『チーと言えばギュウ』は世界共通だと思いますか？" },
  { text:"チーズ牛丼を『恥ずかしくて頼めない』人は実在すると思いますか？" },
  { text:"あなたは『頼めないが、本当は食べたい』側ですか？" },
  { text:"チー牛食おうぜ！と言われたら、行けたら行くよ…と思いますか？" },
  { text:"コンビニでチーズ系を見ると、なぜか心がざわつきますか？" },
  { text:"牛丼屋で『チーズ』の文字を見ると一瞬迷いますか？" },
  { text:"『チー』と『ギュウ』を交互に発声したことがありますか？" },
  { text:"『チーと言えばギュウ』と聞いて、少し安心しますか？" },
  { text:"あなたは自分がチー牛かどうか、時々確認したくなりますか？" },
  { text:"『チー』と聞こえたら反射的に『ギュウ』が頭に浮かびますか？" },
  { text:"『ギュウ』と言う時、なぜか誇らしい気持ちになりますか？" },
  { text:"チーズ牛丼を食べた後、ちょっと強くなった気がしますか？" },
  { text:"『チー牛』という言葉を、心の中だけで使ったことはありますか？" },
  { text:"あなたはチー牛を『悪口』ではなく『概念』だと思いますか？" },
  { text:"チーズ牛丼のCMに石原さとみさんが出演し、イベントで本人に会える世界線があると思いますか？" },
  { text:"チーと言われたら、ギュウと返したいですか？" },
  { text:"ギュウと言ったら、相手に❤で返してほしいですか？" },
  { text:"『チーと言えばギュウ』は、人生のセーフティネットだと思いますか？" },
  { text:"『チー』と『ギュウ』の関係は、もはや運命だと思いますか？" },
  { text:"チーズ牛丼を頼んだ人を見て『分かる』と思ったことはありますか？" },
  { text:"『チー牛』という言葉を聞いても、怒らずスルーできますか？" },
  { text:"あなたは『チーと言えばギュウ』の正解率に自信がありますか？" },
  { text:"『ギュウ』と答えると世界が少し平和になると思いますか？" },
  { text:"最後にひとこと。チーと言えば？" }
];

/* 女の子画像（14枚 + 7〜14追加） */
const girls=[
  "girl_1.png","girl_2.png","girl_3.png","girl_4.png","girl_5.png","girl_6.png",
  "girl_7.png","girl_8.png","girl_9.png","girl_10.png",
  "girl_11.png","girl_12.png","girl_13.png","girl_14.png"
];
/* 通常モード：チー娘乱入（⭐︎/⭐︎⭐︎/⭐︎⭐︎⭐︎） */
const cheeLevelsNormal = [
  { stars:1, timeMs:2400, gauge:"cool",   weight:0.60 },
  { stars:2, timeMs:1700, gauge:"yellow", weight:0.30 },
  { stars:3, timeMs:1200, gauge:"red",    weight:0.10 }
];

/* もっさり＆演出 */
const NORMAL_REACT_MS = 1050;
const QUESTION_SHOW_DELAY = 100;
const CHEE_PRE_HOLD_MS = 620;
const CUT_MS = 320;
const POST_CUT_HOLD_MS = 260;
const CHEE_SILENCE_MS = 180;
const CHEE_SUCCESS_HOLD_MS = 700;
const GIRL_REPLY_DELAY_MS = 500;
const FLASH_ON_MS = 120;

/* 通常モード：チー娘出現率 */
const CHEE_RATE = 0.35;

/* ⭐︎⭐︎⭐︎：ゲージ最初だけ速い */
const STAGE3_BOOST_MS = 500;
const STAGE3_BOOST_MULT = 1.35;

/* チー娘モード：勝つたびステージUP */
let cheeStage = 1;

/* NEW RECORD 演出フラグ（その1プレイ中だけ有効） */
let isNewRecordRun = false;

/* state */
let i=0;
let mode="quiz";           // quiz | chee
let locked=false;
let rafId=0;
let cheeCooldown=false;
let ended=false;
let currentCheeLevel=null;
let gameMode="normal";     // normal | cheeOnly

/* DOM */
const startScreen=document.getElementById("startScreen");
const game=document.getElementById("gameScreen");
const bg=document.querySelector("#gameScreen .bg");
const q=document.getElementById("question");
const s=document.getElementById("speech");
const c=document.getElementById("counter");
const gaugeWrap=document.getElementById("gaugeWrap");
const gauge=document.getElementById("gaugeBar");
const choices=document.getElementById("choices");
const flash=document.getElementById("flash");

const bestOnTop=document.getElementById("bestOnTop");
const newRecordBadge=document.getElementById("newRecordBadge");

/* ===== TOP 表示更新 ===== */
function refreshTopBest(){
  bestOnTop.textContent = `ステージ${getBestStage()}`;
}
function showTopNewRecordBadge(on){
  if(on) newRecordBadge.classList.add("show");
  else newRecordBadge.classList.remove("show");
}

/* ===== WebAudio: 小さいポン ===== */
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
}
function playPopSE(){
  try{
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.setValueAtTime(660, t0);
    osc.frequency.exponentialRampToValueAtTime(880, t0 + 0.03);

    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.18, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.10);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(t0);
    osc.stop(t0 + 0.11);
  }catch(e){}
}

/* helpers */
function randGirl(){ return girls[Math.floor(Math.random()*girls.length)]; }
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }
function setButtonsEnabled(on){
  document.querySelectorAll("#choices button").forEach(b=>b.disabled=!on);
}
function stopCheeTimer(){
  cancelAnimationFrame(rafId);
  rafId=0;
}
function hideGauge(){
  gaugeWrap.classList.remove("show");
  gauge.style.transform="scaleX(0)";
}
function showGauge(){
  gaugeWrap.classList.add("show");
}
function resetCheeVisuals(){
  game.classList.remove("chee","cut","announce","hold","stage3plus");
  hideGauge();
  stopCheeTimer();
  gauge.classList.remove("yellow","red");
  currentCheeLevel=null;
  choices.classList.remove("chee10");
}

/* flash */
function flashBg(){
  flash.classList.add("on");
  setTimeout(()=> flash.classList.remove("on"), FLASH_ON_MS);
}

/* speech */
function clearSpeech(){
  s.className = "speech";
  s.textContent = "";
}
function setSpeechPlain(text){
  s.className = "speech";
  s.textContent = text;
}
function setHeartOnlyPop(isGold=false){
  s.className = "speech " + (isGold ? "heartGold" : "heartOnly");
  s.textContent = "❤";
  s.classList.remove("heartPop");
  void s.offsetWidth;
  s.classList.add("heartPop");
  playPopSE();
  flashBg();
}
function setGyuuWithHeart(){
  s.className = "speech";
  s.innerHTML = `ギュウ<span class="heartOnly">❤</span>`;
}
function setTextWithHeart(text){
  s.className = "speech";
  s.innerHTML = `${text}<span class="heartOnly">❤</span>`;
}

/* ===== ボタン色（全部のボタンに適当に） ===== */
const buttonColors = [
  "#d64545","#c0392b","#e67e22","#f1c40f",
  "#27ae60","#16a085","#2980b9","#8e44ad",
  "#2c3e50","#7f8c8d","#ff6b6b","#ffa502"
];
function applyRandomColorsToButtons(){
  const btns = document.querySelectorAll("#choices button.choice");
  const cols = shuffle(buttonColors);
  btns.forEach((b,idx)=>{
    b.style.background = cols[idx % cols.length];
  });
}

/* UI: 通常4択 */
function buildChoices(){
  choices.classList.remove("chee10");
  choices.innerHTML="";
  const items=[["はい"],["いいえ"],["チー"],["ギュウ"]];
  shuffle(items).forEach(([t])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.className="choice";
    b.onclick=()=>answer(t);
    choices.appendChild(b);
  });
  applyRandomColorsToButtons();
}

/* UI: チー娘モード 10ボタン（位置ランダム） */
function buildChoicesChee10(){
  const decoys = [
    "はい","いいえ","チー","ポン","カン","ドン","モー","牛","チーズ","特盛り",
    "並","大盛り","湯気","ニコッ","クスッ","笑","うし","ぎゅ","チー牛","牛丼"
  ];
  const nine = shuffle(decoys.filter(x=>x!=="ギュウ")).slice(0, 9);
  const labels = shuffle(["ギュウ", ...nine]);

  choices.classList.add("chee10");
  choices.innerHTML="";

  labels.forEach(label=>{
    const b=document.createElement("button");
    b.textContent = label;
    b.className="choice";
    b.onclick=()=>answer(label);
    choices.appendChild(b);
  });

  applyRandomColorsToButtons();
}

/* 背景 */
function applyQuestionBg(){
  bg.style.backgroundImage=`url("${girls[i % girls.length]}")`;
}

/* ===== 通常モード：問題表示 ===== */
function showQuestion(){
  ended=false;
  locked=false;
  mode="quiz";
  resetCheeVisuals();

  applyQuestionBg();

  q.classList.add("hide");
  q.textContent=questions[i].text;
  clearSpeech();
  c.textContent=`${i+1}/${questions.length}`;

  setTimeout(()=> q.classList.remove("hide"), QUESTION_SHOW_DELAY);
  setButtonsEnabled(true);
}

/* ===== 通常モード：チー娘乱入の難易度抽選 ===== */
function pickCheeLevelNormal(){
  const r = Math.random();
  let acc = 0;
  for(const lv of cheeLevelsNormal){
    acc += lv.weight;
    if(r <= acc) return lv;
  }
  return cheeLevelsNormal[0];
}

/* ===== チー娘モード用：ステージ→時間（緩急あり） ===== */
function cheeOnlyPickStage(){
  let stage = cheeStage;

  // たまに遅い個体で緩急（25%）
  if(Math.random() < 0.25){
    stage = Math.max(1, stage - (Math.random()<0.7 ? 1 : 2));
  }

  const stars = stage <= 1 ? 1 : (stage === 2 ? 2 : 3);
  const base = 2400 - (stage - 1) * 120;
  const timeMs = Math.max(550, Math.round(base));
  const gaugeType = stars === 1 ? "cool" : (stars === 2 ? "yellow" : "red");

  return { stars, timeMs, gauge:gaugeType, stage };
}

/* ===== 次へ（通常モード） ===== */
function maybeChee(){
  if(i >= questions.length-1){
    i++;
    if(i < questions.length) showQuestion();
    else end();
    return;
  }
  if(ended) return;

  if(!cheeCooldown && Math.random() < CHEE_RATE){
    cheeCooldown=true;

    setButtonsEnabled(false);
    game.classList.add("hold");
    setTimeout(()=>{
      game.classList.remove("hold");
      startCheeBattle(pickCheeLevelNormal());
    }, CHEE_PRE_HOLD_MS);
  }else{
    cheeCooldown=false;
    i++;
    if(i < questions.length) showQuestion();
    else end();
  }
}

/* ===== チー娘戦開始（共通） ===== */
function startCheeBattle(level){
  if(ended) return;
  mode="chee";
  locked=false;

  currentCheeLevel = level;

  game.classList.add("cut","announce","chee");
  if(level.stars >= 3){
    game.classList.add("stage3plus");
  }

  bg.style.backgroundImage=`url("${randGirl()}")`;

  setTimeout(()=>{
    game.classList.remove("cut","announce");

    q.textContent="";
    q.classList.add("hide");
    clearSpeech();

    setTimeout(()=>{
      s.className = "speech cheeWord" + (level.stars>=3 ? " big" : "");
      s.textContent = "チー！";

      if(gameMode === "cheeOnly") buildChoicesChee10();
      else buildChoices();

      startCheeTimer(level);
      setButtonsEnabled(true);
    }, CHEE_SILENCE_MS);

  }, CUT_MS + POST_CUT_HOLD_MS);
}

/* ===== チー娘タイマー ===== */
function startCheeTimer(level){
  stopCheeTimer();
  showGauge();

  gauge.classList.remove("yellow","red");
  if(level.gauge === "yellow") gauge.classList.add("yellow");
  if(level.gauge === "red") gauge.classList.add("red");

  const start=performance.now();

  const tick=(t)=>{
    let elapsed = t - start;

    if(level.stars >= 3 && elapsed < STAGE3_BOOST_MS){
      elapsed = elapsed * STAGE3_BOOST_MULT;
    }else if(level.stars >= 3 && elapsed >= STAGE3_BOOST_MS){
      const boosted = STAGE3_BOOST_MS * STAGE3_BOOST_MULT;
      elapsed = boosted + (elapsed - STAGE3_BOOST_MS);
    }

    const r = Math.max(0, 1 - (elapsed / level.timeMs));
    gauge.style.transform = `scaleX(${r})`;

    if(level.gauge === "cool"){
      gauge.style.background = `hsl(${210 * r}, 85%, 55%)`;
    }

    if(r > 0){
      rafId = requestAnimationFrame(tick);
    }else{
      gameOver();
    }
  };

  rafId = requestAnimationFrame(tick);
}

/* ===== チー娘モード：勝利でステージ+1 & NEW RECORD判定 ===== */
function nextCheeOnlyAfterWin(){
  cheeStage++;
  c.textContent = `ステージ${cheeStage}`;

  // 勝利で到達ステージ更新（気持ち良い）
  const best = getBestStage();
  if(cheeStage > best){
    setBestStage(cheeStage);
    isNewRecordRun = true; // このプレイ中は金ハート
  }

  const lv = cheeOnlyPickStage();
  startCheeBattle(lv);
}

/* ===== 回答処理 ===== */
function answer(t){
  if(locked || ended) return;
  locked=true;
  setButtonsEnabled(false);

  ensureAudio();
  q.classList.add("hide");

  if(mode==="chee"){
    if(t==="ギュウ"){
      stopCheeTimer();
      hideGauge();

      setTimeout(()=> setHeartOnlyPop(isNewRecordRun), GIRL_REPLY_DELAY_MS);

      setTimeout(()=>{
        resetCheeVisuals();

        if(gameMode === "cheeOnly"){
          nextCheeOnlyAfterWin();
          return;
        }

        i++;
        if(i < questions.length) showQuestion();
        else end();
      }, GIRL_REPLY_DELAY_MS + CHEE_SUCCESS_HOLD_MS);

    }else{
      gameOver();
    }
    return;
  }

  // 通常問題：返事指定（チー以外は ❤️付き）
  setTimeout(()=>{
    if(t==="はい")        setTextWithHeart("笑");
    else if(t==="いいえ") setTextWithHeart("クスッ");
    else if(t==="ギュウ") setTextWithHeart("ニコッ");
    else if(t==="チー")   setGyuuWithHeart();
    else                  setTextWithHeart("笑");
  }, GIRL_REPLY_DELAY_MS);

  setTimeout(maybeChee, GIRL_REPLY_DELAY_MS + NORMAL_REACT_MS);
}

/* ===== クリア / ゲームオーバー：ボタン表示遅延 + トップ戻る ===== */
function renderEndButtonsDelayed(delayMs){
  choices.innerHTML = "";
  setTimeout(()=>{
    choices.innerHTML = `
      <button class="choice" style="grid-column:1/-1" onclick="restart(gameMode)">もう一回</button>
      <button class="choice" style="grid-column:1/-1" onclick="backToTop()">トップに戻る</button>
    `;
    applyRandomColorsToButtons();
  }, delayMs);
}

function end(){
  ended=true;
  resetCheeVisuals();

  bg.style.backgroundImage = `url("${END_CLEAR_IMAGE}")`;
  q.textContent="";
  clearSpeech();

  c.textContent = `${questions.length}/${questions.length}`;

  renderEndButtonsDelayed(0);
}

function gameOver(){
  ended=true;
  resetCheeVisuals();

  bg.style.backgroundImage = `url("${END_GOVER_IMAGE}")`;
  q.textContent="";
  clearSpeech();

  if(gameMode === "cheeOnly"){
    const reachedStage = cheeStage;
    const bestStage = getBestStage();

    // ★①：負けた瞬間にもBEST更新（到達ステージとして）
    if(reachedStage > bestStage){
      setBestStage(reachedStage);
      isNewRecordRun = true;
    }

    const finalBest = Math.max(reachedStage, bestStage);

    setSpeechPlain(`ステージ${reachedStage}でゲームオーバー\n最高ステージ：ステージ${finalBest}`);
    c.textContent = `GAME OVER (ステージ${reachedStage})`;

  }else{
    setSpeechPlain("あなたチー牛じゃなかったのね。。");
    c.textContent = "GAME OVER";
  }

  // 誤タップ防止：1秒後にボタン表示
  renderEndButtonsDelayed(1000);
}

function restart(modeName){
  ended=false;
  cheeCooldown=false;
  mode="quiz";
  locked=false;
  stopCheeTimer();
  resetCheeVisuals();

  gameMode = modeName || "normal";

  // プレイ開始時は NEW RECORD フラグを切る
  isNewRecordRun = false;

  if(gameMode === "cheeOnly"){
    cheeStage = 1;
    c.textContent = `ステージ${cheeStage}`;

    // 既存BESTより進めたらNEW RECORD扱いにしたい場合の準備
    // （勝利 or gameOver で確定するので、ここは触らない）
    startCheeBattle(cheeOnlyPickStage());
  }else{
    i=0;
    buildChoices();
    showQuestion();
  }
}

function backToTop(){
  ended=false;
  stopCheeTimer();
  resetCheeVisuals();
  locked=false;
  mode="quiz";
  cheeCooldown=false;

  game.classList.add("hide");
  startScreen.classList.remove("hide");

  refreshTopBest();
  showTopNewRecordBadge(isNewRecordRun);
}

/* start buttons */
document.getElementById("startBtnNormal").onclick=()=>{
  startScreen.classList.add("hide");
  game.classList.remove("hide");
  showTopNewRecordBadge(false);
  restart("normal");
};
document.getElementById("startBtnChee").onclick=()=>{
  startScreen.classList.add("hide");
  game.classList.remove("hide");
  showTopNewRecordBadge(false);
  restart("cheeOnly");
};

window.restart=restart;
window.backToTop=backToTop;

/* 初期表示：BEST反映 */
refreshTopBest();
</script>

</body>
</html>
