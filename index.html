<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>チーと言えばギュウと答える</title>

<style>
:root{
  --text:#ffffff;
  --muted:#dddddd;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Segoe UI",sans-serif;
  color:var(--text);
  background:#000;
  min-height:100svh;
}
.app{
  width:min(560px,100%);
  margin:0 auto;
  min-height:100svh;
  display:flex;
  flex-direction:column;
}

/* ===== Header ===== */
header{
  padding:12px 16px 10px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  position:sticky;
  top:0;
  z-index:10;
}
.title{
  font-size:14px;
  font-weight:900;
  letter-spacing:0.12em;
}
.meta{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
  font-size:12px;
  color:var(--muted);
}
.minirow{
  display:flex;
  gap:10px;
  align-items:center;
}

/* time gauge */
.gauge{
  width:180px;
  height:8px;
  border-radius:999px;
  background:rgba(255,255,255,0.12);
  overflow:hidden;
}
.gauge > div{
  height:100%;
  width:100%;
  transform-origin:left center;
  transform:scaleX(0);
  transition:transform 50ms linear, background-color 50ms linear;
}

/* ===== Screen ===== */
.screen{ flex:1; position:relative; overflow:hidden; }
.bg{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  transform:scale(1.02);
}
#startScreen .bg{ background-image:url("girl_top.png"); }

/* 暗転カバー（チー娘演出用） */
.cutCover{
  position:absolute;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity 80ms linear;
  z-index:5;
}
#gameScreen.cut .cutCover{ opacity:1; }

/* 「!!」ショック表示（不意打ち用） */
.shock{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:72px;
  font-weight:900;
  letter-spacing:0.08em;
  opacity:0;
  pointer-events:none;
  z-index:7;
  text-shadow:0 8px 24px rgba(0,0,0,0.8);
  transition:opacity 80ms linear;
}
#gameScreen.shock-on .shock{ opacity:1; }

/* Overlay（暗幕：薄く） */
.overlay{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  padding:16px;
  gap:12px;
  background:linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.45));
  z-index:6; /* coverより上 */
}

/* トップ：中央寄せ */
#startScreen .panel{ text-align:center; }
/* ゲーム：上下に広げる */
#gameScreen .overlay{ justify-content:space-between; }

/* チー娘中：吹き出しを少し下げて「近い感じ」 */
#gameScreen.chee-mode .bubble{
  transform:translateY(26px);
  transition:transform 120ms ease;
}
#gameScreen:not(.chee-mode) .bubble{
  transform:translateY(0);
  transition:transform 120ms ease;
}

/* 反応フラッシュ */
#gameScreen.flash .bg{
  filter:saturate(1.1) contrast(1.12) brightness(1.35);
  transition:filter 300ms ease;
}

/* ===== UI ===== */
.panel{ background:none; padding:0; }
.bubble{
  background:rgba(255,255,255,0.08);
  border-radius:14px;
  padding:14px;
  min-height:96px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* 問題文：少し太字 + フェード */
.question{
  font-size:20px;
  line-height:1.45;
  font-weight:600;
  opacity:1;
  transition:opacity 180ms ease;
}
.question.fade{ opacity:0; }

.speech{
  align-self:flex-end;
  font-size:28px;
  font-weight:900;
  letter-spacing:0.12em;
  min-height:34px;
  opacity:1;
  transition:opacity 140ms ease;
}
.speech.fade{ opacity:0; }

/* ===== Choices ===== */
.choices{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
button{
  appearance:none;
  border:none;
  border-radius:12px;
  padding:14px 12px;
  font-size:16px;
  font-weight:900;
  letter-spacing:0.1em;
  color:#fff;
  text-shadow:0 2px 6px rgba(0,0,0,0.6);
  transition:transform 0.1s, filter 0.2s;
}
.choice-yes{ background:#2e8b57; }
.choice-no{ background:#555555; }
.choice-chee{ background:#2f6fb2; }
.choice-gyuu{ background:#e28a2f; }

button:active{ transform:translateY(1px) scale(0.98); }
button:disabled{ opacity:0.55; }
.choice.selected{ filter:brightness(1.25); transform:translateY(2px) scale(0.97); }

/* Top */
.heroTitle{
  font-size:18px;
  font-weight:900;
  letter-spacing:0.14em;
}
.big{
  font-size:18px;
  padding:16px 24px;
  background:#ffffff22;
}
#startBtn{ display:block; margin:0 auto; }
.hide{ display:none; }

@media(max-width:420px){
  .question{ font-size:19px; }
  .gauge{ width:150px; }
  .shock{ font-size:64px; }
}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="title">チーと言えばギュウと答える</div>
  <div class="meta">
    <div class="minirow">
      <span id="counter">-</span>
      <span id="countdown">-</span>
    </div>
    <div class="gauge"><div id="gaugeBar"></div></div>
  </div>
</header>

<!-- ===== START ===== -->
<div id="startScreen" class="screen">
  <div class="bg"></div>
  <div class="overlay">
    <div class="panel">
      <div class="heroTitle">ガチ！チー牛診断！！</div>
      <div style="margin-top:16px;">
        <button class="big" id="startBtn">START</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="gameScreen" class="screen hide">
  <div class="bg"></div>
  <div class="cutCover"></div>
  <div class="shock">!!</div>

  <div class="overlay">
    <div class="bubble">
      <div class="question" id="question">…</div>
      <div class="speech" id="speech">…</div>
    </div>
    <div class="panel">
      <div class="choices" id="choices"></div>
    </div>
  </div>
</div>

</div>

<script>
/* =========================
   通常問題（6問）
========================= */
const questions = [
  { text:"あなたはチー牛ですか？" },
  { text:"チーと言えば？" },
  { text:"石原さとみさんに「チー」と言われたら、あなたは「ギュウ」と答えますか？" },
  { text:"石原さとみさんに「ギュウ」と言ってもらいたいと思いますか？" },
  { text:"チーズ牛丼を頼んだ人を、一瞬だけ見てしまったことはありますか？" },
  { text:"あなたは三度の飯よりチー牛が好きって本当ですか？" }
];

const ALL_CHOICES = ["はい","いいえ","チー","ギュウ"];
const CLASS_MAP = {
  "はい":"choice-yes",
  "いいえ":"choice-no",
  "チー":"choice-chee",
  "ギュウ":"choice-gyuu"
};

/* 画像 */
const GIRL_IMAGES = ["girl_1.png","girl_2.png","girl_3.png","girl_4.png","girl_5.png","girl_6.png"];
const GIRL_END_IMAGE = "girl_end.png";

/* チー娘割り込み */
const CHEE_EVENT_CHANCE = 0.35;
const CHEE_WAIT_MIN_MS = 250;
const CHEE_WAIT_MAX_MS = 900;
const CHEE_TIME_LIMIT_MS = 2200;

/* ========================= */
const startScreen = document.getElementById("startScreen");
const gameScreen  = document.getElementById("gameScreen");
const bgEl        = gameScreen.querySelector(".bg");

const qEl = document.getElementById("question");
const sEl = document.getElementById("speech");
const choicesEl = document.getElementById("choices");

const counterEl = document.getElementById("counter");
const countdownEl = document.getElementById("countdown");
const gaugeBar = document.getElementById("gaugeBar");

let current = 0;
let locked = false;
let mode = "quiz"; // "quiz" | "chee" | "end"

let rafId = 0;
let timeoutId = 0;
let roundStart = 0;

// ★ チー娘が合間に出た後、次の問題へ進めるためのフラグ
let pendingAdvanceAfterChee = false;

function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }
function randInt(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function setButtonsEnabled(on){
  document.querySelectorAll(".choice").forEach(b=>b.disabled = !on);
}

function buildButtons(){
  choicesEl.innerHTML="";
  shuffle(ALL_CHOICES).forEach(t=>{
    const b=document.createElement("button");
    b.className="choice "+CLASS_MAP[t];
    b.textContent=t;
    b.onclick=()=>answer(t,b);
    choicesEl.appendChild(b);
  });
}

function flash(){
  gameScreen.classList.add("flash");
  setTimeout(()=>gameScreen.classList.remove("flash"),300);
}

/* ゲージ：寒色→暖色 */
function setGauge(ratio){
  const clamped = Math.max(0, Math.min(1, ratio));
  gaugeBar.style.transform = `scaleX(${clamped})`;
  const hue = 210 * clamped; // 青 -> 赤
  gaugeBar.style.backgroundColor = `hsl(${hue}, 85%, 55%)`;
}

function stopTimer(){
  cancelAnimationFrame(rafId);
  clearTimeout(timeoutId);
  rafId = 0;
  timeoutId = 0;
}

function updateQuizGirl(){
  const img = GIRL_IMAGES[current % GIRL_IMAGES.length];
  bgEl.style.backgroundImage = `url("${img}")`;
}

/* ===== 通常問題表示 ===== */
function showQuestion(){
  mode = "quiz";
  locked = false;
  stopTimer();
  gameScreen.classList.remove("chee-mode");

  updateQuizGirl();

  counterEl.textContent = `${current+1}/${questions.length}`;
  countdownEl.textContent = "-";
  setGauge(0);

  // 問題文：0.1秒遅延→フェードイン
  qEl.classList.add("fade");
  qEl.textContent = "";
  sEl.textContent = "…";

  setTimeout(()=>{
    qEl.textContent = questions[current].text;
    requestAnimationFrame(()=> qEl.classList.remove("fade"));
  }, 100);

  setButtonsEnabled(true);
}

/* ===== 次へ行く前に割り込み判定 ===== */
function maybeCheeEventThenNext(){
  if(Math.random() < CHEE_EVENT_CHANCE){
    pendingAdvanceAfterChee = true; // ★ チー娘後に次の問題へ進む
    const wait = randInt(CHEE_WAIT_MIN_MS, CHEE_WAIT_MAX_MS);
    setButtonsEnabled(false);
    setTimeout(()=>startCheeEvent(), wait);
  }else{
    current++;
    if(current < questions.length) showQuestion();
    else endScreen();
  }
}

/* ===== 暗転 + 「!!」 + 画像差し替え ===== */
function shockOnce(){
  gameScreen.classList.add("shock-on");
  setTimeout(()=>gameScreen.classList.remove("shock-on"), 120);
}

function darkCutAndSwapImage(newImage, after){
  shockOnce();                 // 「!!」一瞬
  gameScreen.classList.add("cut"); // 暗転

  // 暗転中に画像差し替え
  setTimeout(()=>{
    bgEl.style.backgroundImage = `url("${newImage}")`;
    // すぐ復帰（パッ）
    setTimeout(()=>{
      gameScreen.classList.remove("cut");
      after?.();
    }, 60);
  }, 80);
}

/* ===== チー娘イベント開始 ===== */
function startCheeEvent(){
  mode = "chee";
  locked = false;
  gameScreen.classList.add("chee-mode");

  const cheeImg = randChoice(GIRL_IMAGES);

  darkCutAndSwapImage(cheeImg, ()=>{
    qEl.classList.add("fade");
    sEl.classList.add("fade");
    qEl.textContent = "";
    sEl.textContent = "";

    setTimeout(()=>{
      qEl.textContent = "";
      sEl.textContent = "チー";
      requestAnimationFrame(()=>{
        qEl.classList.remove("fade");
        sEl.classList.remove("fade");
      });

      counterEl.textContent = `${current+1}/${questions.length}`;
      beginCheeTimer();
      setButtonsEnabled(true);
    }, 100);
  });
}

function beginCheeTimer(){
  stopTimer();
  roundStart = performance.now();

  const tick = (now)=>{
    const elapsed = now - roundStart;
    const remain = Math.max(0, CHEE_TIME_LIMIT_MS - elapsed);
    const ratio  = remain / CHEE_TIME_LIMIT_MS;

    countdownEl.textContent = (remain/1000).toFixed(1);
    setGauge(ratio);

    if(remain <= 0){
      gameOver("TIMEOUT");
      return;
    }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
  timeoutId = setTimeout(()=>gameOver("TIMEOUT"), CHEE_TIME_LIMIT_MS + 60);
}

/* ===== 回答処理 ===== */
function answer(choice, btn){
  if(locked) return;
  locked = true;

  qEl.classList.add("fade");
  btn.classList.add("selected");
  setButtonsEnabled(false);

  if(mode === "chee"){
    // チー娘：正解は「ギュウ」だけ
    const ok = (choice === "ギュウ");
    if(ok){
      stopTimer();
      sEl.textContent = "ギュウ";

      setTimeout(()=>{
        countdownEl.textContent = "-";
        setGauge(0);

        // ★ チー娘が合間に出た場合は、次の問題へ進む
        gameScreen.classList.remove("chee-mode");
        mode = "quiz";

        if(pendingAdvanceAfterChee){
          pendingAdvanceAfterChee = false;
          current++;
          if(current < questions.length) showQuestion();
          else endScreen();
        }else{
          // 念のため：通常に戻す（基本はここに来ない）
          showQuestion();
        }
      }, 350);
    }else{
      gameOver("WRONG");
    }
    return;
  }

  // ===== 通常問題：正解/不正解は見ない =====
  // 「チー」を押した時だけギュウ、他は……
  const reactOk = (choice === "チー");
  if(reactOk) flash();
  sEl.textContent = reactOk ? "ギュウ" : "……";

  setTimeout(()=>{
    maybeCheeEventThenNext();
  }, 650);
}

/* ===== 終了・ゲームオーバー ===== */
function endScreen(){
  mode = "end";
  stopTimer();
  gameScreen.classList.remove("chee-mode");
  pendingAdvanceAfterChee = false;

  bgEl.style.backgroundImage = `url("${GIRL_END_IMAGE}")`;

  qEl.textContent = "";
  sEl.textContent = "";
  qEl.classList.add("fade");
  sEl.classList.add("fade");

  counterEl.textContent = `${questions.length}/${questions.length}`;
  countdownEl.textContent = "-";
  setGauge(0);

  choicesEl.innerHTML = `<button class="big" onclick="restart()">もう一回</button>`;
}

function gameOver(reason){
  mode = "end";
  stopTimer();
  gameScreen.classList.remove("chee-mode");
  pendingAdvanceAfterChee = false;

  bgEl.style.backgroundImage = `url("${GIRL_END_IMAGE}")`;

  qEl.textContent = "";
  sEl.textContent = "";
  qEl.classList.add("fade");
  sEl.classList.add("fade");

  counterEl.textContent = "GAME OVER";
  countdownEl.textContent = "-";
  setGauge(0);

  choicesEl.innerHTML = `<button class="big" onclick="restart()">もう一回</button>`;
}

function restart(){
  stopTimer();
  pendingAdvanceAfterChee = false;
  current = 0;
  buildButtons();
  showQuestion();
}

document.getElementById("startBtn").onclick = ()=>{
  startScreen.classList.add("hide");
  gameScreen.classList.remove("hide");
  buildButtons();
  restart();
};

window.restart = restart;
</script>

</body>
</html>
