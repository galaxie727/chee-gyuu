<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>チーと言えばギュウと答える</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
}
.app{
  max-width:560px;
  margin:0 auto;
  min-height:100svh;
  display:flex;
  flex-direction:column;
}

/* ===== header ===== */
header{
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  font-size:12px;
  font-weight:700;
}

/* ===== screen ===== */
.screen{flex:1;position:relative;overflow:hidden}
.bg{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  transform:scale(1.02);
  transition:transform .25s ease;
}
#startScreen .bg{background-image:url("girl_top.png")}
.overlay{
  position:absolute;
  inset:0;
  padding:16px;
  display:flex;
}

/* ===== start ===== */
#startScreen .overlay{
  justify-content:center;
  align-items:flex-end;
  padding-bottom:28px;
}
.startPanel{text-align:center}
.startTitle{
  font-size:18px;
  font-weight:900;
  letter-spacing:.14em;
  margin-bottom:14px;
}
#startBtn{
  font-size:18px;
  padding:14px 28px;
  border:none;
  border-radius:14px;
  background:#ffffff22;
  color:#fff;
  font-weight:900;
}

/* ===== game ===== */
#gameScreen .overlay{
  flex-direction:column;
  justify-content:space-between;
}
#gameScreen.chee .bg{transform:scale(1.12)}

.vignette{
  position:absolute;inset:0;
  pointer-events:none;
  opacity:0;
  background:radial-gradient(circle,
    rgba(0,0,0,0) 45%,
    rgba(0,0,0,.45) 100%);
  transition:opacity .2s;
}
#gameScreen.chee .vignette{opacity:1}

/* ===== effects ===== */
.cut{
  position:absolute;inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity .22s;
}
#gameScreen.cut .cut{opacity:1}

@keyframes shake{
  0%{transform:translate(0,0)}
  25%{transform:translate(-4px,2px)}
  50%{transform:translate(3px,-2px)}
  75%{transform:translate(-2px,1px)}
  100%{transform:translate(0,0)}
}
#gameScreen.shake{animation:shake .12s}

.announce{
  position:absolute;inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:900;
  letter-spacing:.2em;
  opacity:0;
  pointer-events:none;
  transition:opacity .12s;
}
#gameScreen.announce .announce{opacity:1}

/* ===== bubble ===== */
.bubble{
  background:rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  min-height:120px;
}
.question{
  font-size:20px;
  font-weight:600;
  transition:opacity .12s;
}
.question.hide{opacity:0}
.speech{
  align-self:flex-end;
  font-size:34px;
  font-weight:900;
  letter-spacing:.12em;
  min-height:40px;
}

/* ===== choices ===== */
.choices{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.choice{
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:900;
  color:#fff;
}
.yes{background:#2e8b57}
.no{background:#555}
.cheeBtn{background:#2f6fb2}
.gyuuBtn{background:#e28a2f}

/* ===== gauge (チー娘中だけ表示) ===== */
.gauge{
  height:8px;
  background:#222;
  border-radius:999px;
  overflow:hidden;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .12s, transform .12s;
}
.gauge.show{
  opacity:1;
  transform:translateY(0);
}
.gauge>div{
  height:100%;
  width:100%;
  transform-origin:left;
  transform:scaleX(0);
}

.hide{display:none}
</style>
</head>

<body>
<div class="app">

<header>
  <div>チーと言えばギュウ</div>
  <div id="counter">-</div>
</header>

<!-- START -->
<div id="startScreen" class="screen">
  <div class="bg"></div>
  <div class="overlay">
    <div class="startPanel">
      <div class="startTitle">ガチ！チー牛診断！！</div>
      <button id="startBtn">START</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen hide">
  <div class="bg"></div>
  <div class="vignette"></div>
  <div class="cut"></div>
  <div class="announce">チー娘登場！！</div>

  <div class="overlay">
    <div class="bubble">
      <div id="question" class="question"></div>
      <div id="speech" class="speech"></div>
    </div>

    <div class="gauge" id="gaugeWrap"><div id="gaugeBar"></div></div>
    <div class="choices" id="choices"></div>
  </div>
</div>

</div>

<script>
/* ===== 設定 ===== */
const questions=[
 "あなたはチー牛ですか？","チーと言えば？","チーズ牛丼好き？",
 "三度の飯よりチー牛？","チー牛を見たことある？","ギュウって言いたい？"
];
const girls=["girl_1.png","girl_2.png","girl_3.png","girl_4.png","girl_5.png","girl_6.png"];
const END="girl_end.png";

const CHEE_RATE=.35;
const CHEE_TIME=2200;

let i=0;
let mode="quiz";
let locked=false;

let rafId=0;
let cheeCooldown=false; // 連続防止（通常問題1つ挟む）
let ended=false;        // 終了状態（終盤バグ防止）

/* ===== DOM ===== */
const game=document.getElementById("gameScreen");
const bg=document.querySelector("#gameScreen .bg");
const q=document.getElementById("question");
const s=document.getElementById("speech");
const c=document.getElementById("counter");
const gaugeWrap=document.getElementById("gaugeWrap");
const gauge=document.getElementById("gaugeBar");
const choices=document.getElementById("choices");

/* ===== Helper ===== */
function randGirl(){ return girls[Math.floor(Math.random()*girls.length)]; }
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }

function stopCheeTimer(){
  cancelAnimationFrame(rafId);
  rafId=0;
}

function hideGauge(){
  gaugeWrap.classList.remove("show");
  gauge.style.transform="scaleX(0)";
}

function showGauge(){
  gaugeWrap.classList.add("show");
}

function resetCheeVisuals(){
  // チー娘状態の見た目を必ず解除
  game.classList.remove("chee","cut","announce","shake");
  hideGauge();
  stopCheeTimer();
}

/* ===== UI ===== */
function buildChoices(){
  choices.innerHTML="";
  const items = [["はい","yes"],["いいえ","no"],["チー","chee"],["ギュウ","gyuu"]];
  shuffle(items).forEach(([t,cl])=>{
    const b=document.createElement("button");
    b.textContent=t;
    b.className=`choice ${cl==="chee"?"cheeBtn":cl==="gyuu"?"gyuuBtn":cl}`;
    b.onclick=()=>answer(t);
    choices.appendChild(b);
  });
}

function showQuestion(){
  ended=false;
  locked=false;
  mode="quiz";
  resetCheeVisuals();

  bg.style.backgroundImage=`url("${girls[i%girls.length]}")`;
  q.textContent=questions[i];
  q.classList.remove("hide");
  s.textContent="";

  c.textContent=`${i+1}/${questions.length}`;
}

/* ===== 進行 ===== */
function maybeChee(){
  // ★ 最終問題の後はチー娘を出さない
  if(i >= questions.length-1){
    i++;
    if(i < questions.length) showQuestion();
    else end();
    return;
  }

  // ★ 終了状態なら何もしない
  if(ended) return;

  // ★ 連続防止：チー娘の次は必ず通常問題
  if(!cheeCooldown && Math.random()<CHEE_RATE){
    cheeCooldown=true;
    setTimeout(startChee,300);
  }else{
    cheeCooldown=false;
    i++;
    if(i < questions.length) showQuestion();
    else end();
  }
}

function startChee(){
  if(ended) return;

  mode="chee";
  locked=false;
  // チー娘開始：演出
  game.classList.add("shake","cut","announce");

  // 暗転 220ms
  setTimeout(()=>{
    game.classList.remove("shake");
    game.classList.add("chee");
    bg.style.backgroundImage=`url("${randGirl()}")`;

    // 暗転後の溜め 180ms
    setTimeout(()=>{
      game.classList.remove("cut","announce");

      // 問題文なし、セリフ表示だけ
      q.textContent="";
      q.classList.add("hide");
      s.textContent="";

      // 0.15秒沈黙 → 「チー」
      setTimeout(()=>{
        s.textContent="チー";
        startCheeTimer();
      },150);

    },180);
  },220);
}

function startCheeTimer(){
  stopCheeTimer();
  showGauge();

  const start=performance.now();
  const tick=(t)=>{
    const r=Math.max(0,1-(t-start)/CHEE_TIME);
    gauge.style.transform=`scaleX(${r})`;
    gauge.style.background=`hsl(${210*r},85%,55%)`;
    if(r>0){
      rafId=requestAnimationFrame(tick);
    }else{
      gameOver();
    }
  };
  rafId=requestAnimationFrame(tick);
}

/* ===== Answer ===== */
function answer(t){
  if(locked || ended) return;
  locked=true;

  // 回答したら問題文を消す
  q.classList.add("hide");

  if(mode==="chee"){
    if(t==="ギュウ"){
      stopCheeTimer();
      hideGauge();
      s.textContent="ギュウ";

      // ★ チー娘成功後は必ず次の問題へ
      setTimeout(()=>{
        resetCheeVisuals();
        i++;
        if(i < questions.length) showQuestion();
        else end();
      },500);
    }else{
      gameOver();
    }
    return;
  }

  // 通常問題：チー押した時だけギュウ、それ以外は……
  s.textContent=(t==="チー") ? "ギュウ" : "……";

  setTimeout(maybeChee,650);
}

/* ===== END / GAMEOVER ===== */
function end(){
  ended=true;
  resetCheeVisuals();

  bg.style.backgroundImage=`url("${END}")`;
  q.textContent="";
  s.textContent="";
  choices.innerHTML=`<button class="choice gyuuBtn" style="grid-column:1/-1" onclick="restart()">もう一回</button>`;
  c.textContent=`${questions.length}/${questions.length}`;
}

function gameOver(){
  ended=true;
  resetCheeVisuals();

  bg.style.backgroundImage=`url("${END}")`;
  q.textContent="";
  s.textContent="";
  choices.innerHTML=`<button class="choice gyuuBtn" style="grid-column:1/-1" onclick="restart()">もう一回</button>`;
  c.textContent="GAME OVER";
}

function restart(){
  ended=false;
  cheeCooldown=false;
  i=0;
  buildChoices();
  showQuestion();
}

/* ===== Start ===== */
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("startScreen").classList.add("hide");
  game.classList.remove("hide");
  buildChoices();
  showQuestion();
};
window.restart=restart;
</script>

</body>
</html>
